"""
Chunk Formatter
RAGë¡œ ê²€ìƒ‰ëœ ì²­í¬ë“¤ì„ ê°€ë…ì„± ì¢‹ê²Œ í¬ë§·íŒ…í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ì œê³µ

ì˜ˆì‹œ ì¶œë ¥:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“„ ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Œ ì´ 10ê°œì˜ ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.

[ë¬¸ì„œ 1] ì‚°ì—…ì•ˆì „ë³´ê±´ê¸°ì¤€ì— ê´€í•œ ê·œì¹™.pdf
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì‘ì—…ë°œíŒì€ ê²¬ê³ í•œ êµ¬ì¡°ë¡œ ì„¤ì¹˜ë˜ì–´ì•¼ í•˜ë©°, ì•ˆì „ë‚œê°„ì„
ì„¤ì¹˜í•˜ì—¬ì•¼ í•œë‹¤...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ë¬¸ì„œ 2] ê±´ì„¤ê³µì‚¬ ì•ˆì „ê´€ë¦¬ ë§¤ë‰´ì–¼.pdf
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì¶”ë½ë°©ì§€ë¥¼ ìœ„í•œ ì•ˆì „ëŒ€ ì°©ìš© ì˜ë¬´...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""

from typing import List, Any
from core.llm_utils import call_llm


class ChunkFormatter:
    """RAG ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê°€ë…ì„± ì¢‹ê²Œ í¬ë§·íŒ…"""
    
    def format_chunks(self, docs: List[Any], user_query: str) -> str:
        """
        ê²€ìƒ‰ëœ ë¬¸ì„œë“¤ì„ ê°€ë…ì„± ì¢‹ê²Œ í¬ë§·íŒ…
        
        Args:
            docs: ê²€ìƒ‰ëœ Document ë¦¬ìŠ¤íŠ¸
            user_query: ì‚¬ìš©ì ì§ˆì˜
        
        Returns:
            í¬ë§·íŒ…ëœ ë¬¸ìì—´
        """
        if not docs:
            return "âŒ ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
        
        # 1) ë¬¸ì„œ ì •ë³´ ìˆ˜ì§‘
        chunks_info = []
        for idx, doc in enumerate(docs, 1):
            metadata = getattr(doc, "metadata", {}) or {}
            content = getattr(doc, "page_content", "")
            
            chunks_info.append({
                "idx": idx,
                "filename": metadata.get("source", "ì•Œ ìˆ˜ ì—†ìŒ"),
                "section": metadata.get("section", ""),
                "content": content
            })
        
        # 2) LLMìœ¼ë¡œ ìš”ì•½ ë° í¬ë§·íŒ…
        formatted = self._format_with_llm(chunks_info, user_query)
        
        return formatted
    
    def _format_with_llm(self, chunks_info: List[dict], user_query: str) -> str:
        """LLMì„ ì‚¬ìš©í•˜ì—¬ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ìš”ì•½í•˜ê³  í¬ë§·íŒ…"""
        
        system_prompt = """
ë‹¹ì‹ ì€ RAG ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬í•˜ëŠ” Formatterì…ë‹ˆë‹¤.

## ì¶œë ¥ í˜•ì‹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“„ ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Œ ì´ {n}ê°œì˜ ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.

ğŸ’¡ í•µì‹¬ ë‚´ìš© ìš”ì•½:
[ì‚¬ìš©ì ì§ˆì˜ì™€ ê´€ë ¨ëœ í•µì‹¬ ë‚´ìš©ì„ 2-3ì¤„ë¡œ ìš”ì•½]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“š ìƒì„¸ ë¬¸ì„œ ë‚´ìš©
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[ë¬¸ì„œ 1] íŒŒì¼ëª…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê´€ë ¨ ë‚´ìš© (200ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ë¬¸ì„œ 2] íŒŒì¼ëª…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê´€ë ¨ ë‚´ìš© (200ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ì§€ì¹¨:
1. ì‚¬ìš©ì ì§ˆì˜ì™€ ê´€ë ¨ëœ í•µì‹¬ ë‚´ìš©ë§Œ ì¶”ì¶œí•˜ì„¸ìš”
2. ê° ë¬¸ì„œëŠ” 200ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•˜ì„¸ìš”
3. ì¤‘ìš”í•œ ì•ˆì „ ê·œì •, ìˆ˜ì¹˜, ê¸°ì¤€ì€ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”
4. ë¬¸ì„œ ì¶œì²˜(íŒŒì¼ëª…)ëŠ” ë°˜ë“œì‹œ í‘œì‹œí•˜ì„¸ìš”
5. ì „ì²´ì ìœ¼ë¡œ ê°€ë…ì„±ì´ ì¢‹ì•„ì•¼ í•©ë‹ˆë‹¤
"""
        
        # ë¬¸ì„œ ì •ë³´ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        docs_text = "\n\n".join([
            f"[ë¬¸ì„œ {chunk['idx']}]\n"
            f"íŒŒì¼: {chunk['filename']}\n"
            f"ë‚´ìš©: {chunk['content'][:500]}..."
            for chunk in chunks_info
        ])
        
        user_message = f"""
ì‚¬ìš©ì ì§ˆì˜: {user_query}

ê²€ìƒ‰ëœ ë¬¸ì„œë“¤:
{docs_text}

ìœ„ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬í•´ì£¼ì„¸ìš”.
"""
        
        try:
            response = call_llm(
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_message}
                ],
                temperature=0.3,
                max_tokens=2000
            )
            
            return response
            
        except Exception as e:
            print(f"âš ï¸ LLM í¬ë§·íŒ… ì‹¤íŒ¨: {e}")
            # Fallback: ê°„ë‹¨í•œ í¬ë§·íŒ…
            return self._simple_format(chunks_info)
    
    def _simple_format(self, chunks_info: List[dict]) -> str:
        """LLM ì‹¤íŒ¨ ì‹œ ê°„ë‹¨í•œ í¬ë§·íŒ…"""
        output = "â”" * 60 + "\n"
        output += "ğŸ“„ ê²€ìƒ‰ ê²°ê³¼\n"
        output += "â”" * 60 + "\n\n"
        output += f"ğŸ“Œ ì´ {len(chunks_info)}ê°œì˜ ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.\n\n"
        output += "â”" * 60 + "\n"
        output += "ğŸ“š ìƒì„¸ ë¬¸ì„œ ë‚´ìš©\n"
        output += "â”" * 60 + "\n\n"
        
        for chunk in chunks_info[:5]:  # ìƒìœ„ 5ê°œë§Œ
            output += f"[ë¬¸ì„œ {chunk['idx']}] {chunk['filename']}\n"
            output += "â”€" * 60 + "\n"
            content = chunk['content'][:200]
            output += f"{content}...\n"
            output += "â”€" * 60 + "\n\n"
        
        return output